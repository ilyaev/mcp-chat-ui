# Copilot Instructions for MCP Chat UI

## Project Overview

This is a multi-component TypeScript/React project for a chat UI that integrates with agents and tools via WebSocket. The architecture is split between a client-side React app (in `client/`) and server-side logic (in `src/server/`). Redux is used for state management, and Vite is the build tool.

## Key Components & Data Flow

- **Client App (`client/src/`)**: Main React UI, organized by feature (chat, chart, common, ui).
  - **Chat**: Managed by Redux slice (`store/slices/chatSessionSlice.ts`). Handles chat items, agent/tool responses, and session state.
  - **WebSocket Integration**: `lib/ws_client.ts` manages connection, message dispatch, and tool/agent result handling. Tool calls and chart data are handled as special message types.
  - **UI Patterns**: Uses Radix UI, TailwindCSS, and custom components in `components/ui/`.
- **Server (`src/server/`)**: Handles WebSocket connections, authentication, and agent/tool orchestration.
- **Agents & Tools**: Defined in `src/agents/` and `src/tools/`. Agents process chat prompts; tools (e.g., chart generator) respond to tool calls.

## Developer Workflows

- **Build**: `npm run build` (runs TypeScript build and Vite build)
- **Dev Server**: `npm run dev` (starts Vite dev server)
- **Lint**: `npm run lint` (ESLint)
- **Preview**: `npm run preview` (Vite preview)
- **Hot Reload**: Supported via Vite and React Fast Refresh
- **Redux State**: Use slices in `store/slices/` and actions for chat/agent/tool state updates

## Conventions & Patterns

- **Path Aliases**: Use `@/` for `client/src/` imports (see `tsconfig.json` and `vite.config.ts`)
- **Chat/Tool/Chart Handling**: Chat items and tool/chart responses are managed as objects in Redux state. Tool calls and chart data are handled as special message types in WebSocket client and Redux slice.
- **Error Handling**: WebSocket errors are appended to chat responses and update state.
- **Session Management**: Each WebSocket client has a unique session ID; session state is managed in Redux.
- **UI Composition**: Use Radix UI and custom components for consistent design. See `components/ui/` for reusable UI elements.

## Integration Points

- **WebSocket**: All agent/tool communication is via WebSocket (`lib/ws_client.ts`).
- **Google Auth**: Integrated via `common/GoogleAuth.tsx` and session state.
- **Charts**: Chart data is generated by tools and rendered via chart components in `components/chart/`.

## Examples

- **Adding a Chat Item**: Use `addItem` action from `chatSessionSlice`.
- **Handling Tool Call**: Dispatch `addToolCall` with tool call payload; chart data is handled by `addChartItem`.
- **Connecting WebSocket**: Instantiate `WebSocketSessionClient` with Google ID token and Redux dispatch.

## How to Register a New MCP Tool

To add a new MCP tool (server-side function callable by agents):

1. **Create a new file in `src/tools/`**
   - Name it `[tool_name]_tool.ts`.
2. **Export a default function** that takes an `McpServer` and calls `mcpServer.registerTool`.
   - Define `inputSchema` and `outputSchema` using `zod`.
   - Example:
     ```ts
     import { z } from "zod";
     import { McpServer } from "@modelcontextprotocol/sdk/server/mcp";
     const registerMyTool = (mcpServer: McpServer) => {
       mcpServer.registerTool(
         "my_tool_name",
         {
           title: "My Tool",
           description: "Describe what your tool does.",
           inputSchema: { param1: z.string(), param2: z.number() },
           outputSchema: { result: z.string() },
         },
         async (input) => {
           // Tool logic here
           return {
             content: [{ type: "text", text: "..." }],
             structuredContent: { result: "..." },
           };
         }
       );
     };
     export default registerMyTool;
     ```
3. **No manual registration needed**: All `.ts` files in `src/tools/` are auto-loaded and registered by the MCP server (`src/server/mcp.ts`).
4. **Tool will be available to agents** after server restart.

### Example Copilot Request

> register new tool with name `my_tool_name`, input parameters `param1: string`, `param2: number`, output fields `result: string`

Copilot will generate the file and code for you.

## References

- `client/src/store/slices/chatSessionSlice.ts`: Chat/session state logic
- `client/src/lib/ws_client.ts`: WebSocket client and message handling
- `client/src/components/chat/`: Chat UI components
- `client/src/components/chart/`: Chart rendering components
- `client/src/components/common/GoogleAuth.tsx`: Google authentication
- `client/vite.config.ts`, `client/tsconfig.json`: Build and path alias config

---
